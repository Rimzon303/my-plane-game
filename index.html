<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sky World Explorer</title>
    <style>
        :root {
            --sky-blue: #A2D9FF;
            --btn-blue: #3498db;
            --win-green: #2ecc71;
            --loss-red: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background: linear-gradient(180deg, var(--sky-blue) 0%, #ffffff 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* –ó–∞–ø—Ä–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .top-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .screen { flex: 1; display: none; flex-direction: column; align-items: center; padding: 15px; overflow-y: auto; }
        .active-screen { display: flex; }

        /* –ö–ª–∏–∫–µ—Ä */
        #plane {
            font-size: 100px;
            margin-top: 80px;
            cursor: pointer;
            transition: transform 0.05s;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
            -webkit-tap-highlight-color: transparent;
        }
        #plane:active { transform: scale(0.85); }

        /* –ú–∞–≥–∞–∑–∏–Ω */
        .shop-container { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .case-card {
            background: white;
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .case-icon { font-size: 40px; }
        .spin-anim { font-size: 30px; font-weight: bold; color: #f39c12; margin: 10px 0; min-height: 40px;}

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            background: var(--btn-blue);
            color: white; border: none; padding: 10px 20px;
            border-radius: 12px; font-weight: bold; cursor: pointer;
        }
        .btn:disabled { background: #ccc; }

        /* –§–∏–ª—å—Ç—Ä—ã –∏—Å—Ç–æ—Ä–∏–∏ */
        .filters { display: flex; gap: 10px; margin-bottom: 15px; }
        .filter-btn { padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; background: white; cursor: pointer; }
        .filte
r-active { background: var(--btn-blue); color: white; border-color: var(--btn-blue); }

        .history-list { width: 100%; }
        .history-item { 
            background: white; margin-bottom: 5px; padding: 10px; 
            border-radius: 10px; display: flex; justify-content: space-between; 
        }

        /* –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å */
        .inventory-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
        .inv-item { background: white; padding: 15px; border-radius: 15px; text-align: center; border: 2px solid gold; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { height: 70px; background: white; display: flex; border-top: 1px solid #eee; }
        .nav-btn { flex: 1; border: none; background: none; font-size: 11px; color: #7f8c8d; cursor: pointer; }
        .nav-btn.active { color: var(--btn-blue); font-weight: bold; }
        .nav-btn span { display: block; font-size: 20px; }
    </style>
</head>
<body>

    <div class="top-bar">‚úàÔ∏è <span id="score">0</span></div>

    <!-- –ö–ª–∏–∫–µ—Ä -->
    <div id="scr-click" class="screen active-screen">
        <div id="plane" onclick="clickPlane()">‚úàÔ∏è</div>
        <p>–õ–µ—Ç–∏ –≤—ã—à–µ!</p>
    </div>

    <!-- –ú–∞–≥–∞–∑–∏–Ω -->
    <div id="scr-shop" class="screen">
        <h3>–ú–∞–≥–∞–∑–∏–Ω –ö–µ–π—Å–æ–≤</h3>
        <div class="shop-container">
            <div class="case-card">
                <div class="case-icon">ü•â</div>
                <b>–ë—Ä–æ–Ω–∑–æ–≤—ã–π (100)</b>
                <div id="spin-bronze" class="spin-anim">- - -</div>
                <button id="btn-bronze" class="btn" onclick="openCase('bronze')">–û–¢–ö–†–´–¢–¨</button>
            </div>
            <div class="case-card">
                <div class="case-icon">ü•à</div>
                <b>–°–µ—Ä–µ–±—Ä—è–Ω—ã–π (500)</b>
                <div id="spin-silver" class="spin-anim">- - -</div>
                <button id="btn-silver" class="btn" onclick="openCase('silver')">–û–¢–ö–†–´–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div id="scr-hist" class="screen">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –ò–≥—Ä</h3>
        <div class="filters">
            <button id="f-win" class="filter-btn" onclick="setFilter('win')">–ü–æ–±–µ–¥—ã</button>
            <button id="f-loss" class="filter-btn" onclick="setFilter('loss')">–ü—Ä–æ–∏–≥—Ä—ã—à–∏</button>
            <button id="f-all" class="filter-btn filter-active" onclick="setFilter('all')">–í—Å–µ</button>
        </div>
        <div id="hist-content" class="history-list"></div>
    </div>

    <!-- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å -->
    <div id="scr-inv" class="screen">
        <h3>–ú–æ–π –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        <div id="inv-grid" class="inventory-grid"></div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="nav">
        <button class="nav-btn active" onclick="nav('scr-click', this)"><span>üïπÔ∏è</span>–ò–ì–†–ê</button>
        <button class="nav-btn" onclick="nav('scr-shop', this)"><span>üõí</span>–ú 
 –ì–ê–ó–ò–ù</button>
        <button class="nav-btn" onclick="nav('scr-hist', this)"><span>üìú</span>–ò–°–¢–û–†–ò–Ø</button>
        <button class="nav-btn" onclick="nav('scr-inv', this)"><span>üì¶</span>–ò–ù–í–ï–ù–¢–ê–†–¨</button>
    </div>

    <script>
        let score = parseInt(localStorage.getItem('sk_score')) || 0;
        let history = JSON.parse(localStorage.getItem('sk_hist')) || [];
        let items = JSON.parse(localStorage.getItem('sk_inv')) || [];
        let currentFilter = 'all';

        function updateUI() {
            document.getElementById('score').innerText = score;
            document.getElementById('btn-bronze').disabled = score < 100;
            document.getElementById('btn-silver').disabled = score < 500;
            save();
        }

        function save() {
            localStorage.setItem('sk_score', score);
            localStorage.setItem('sk_hist', JSON.stringify(history));
            localStorage.setItem('sk_inv', JSON.stringify(items));
        }

        function clickPlane() {
            score++;
            updateUI();
        }

        function openCase(type) {
            const cost = type === 'bronze' ? 100 : 500;
            if (score < cost) return;
            
            score -= cost;
            updateUI();
            
            const spinEl = document.getElementById('spin-' + type);
            let steps = 0;
            const interval = setInterval(() => {
                spinEl.innerText = Math.floor(Math.random() * 1000);
                steps++;
                if (steps > 15) {
                    clearInterval(interval);
                    finalizeCase(type, cost);
                }
            }, 80);
        }

        function finalizeCase(type, cost) {
            let win = 0;
            let gotBear = false;

            if (type === 'bronze') {
                const rand = Math.random();
                if (rand > 0.9) win = 300;
                else if (rand > 0.5) win = 120;
                else win = 20;
            } else {
                // –°–µ—Ä–µ–±—Ä—è–Ω—ã–π: –æ—Ç 100 –¥–æ 1000 —Å —à–∞–≥–æ–º 100
                const prizes = [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000];
                win = prizes[Math.floor(Math.random() * prizes.length)];
                if (win === 1000) {
                    gotBear = true;
                }
            }

            if (gotBear) {
                items.push({ name: "–ó–æ–ª–æ—Ç–æ–π –ú–∏—à–∫–∞", icon: "üß∏", date: new Date().toLocaleDateString() });
                document.getElementById('spin-' + type).innerText = "üß∏ –ú–ò–®–ö–ê!";
            } else {
                score += win;
                document.getElementById('spin-' + type).innerText = "+" + win;
            }

            const profit = win - cost;
            history.unshift({
                type: type === 'bronze' ? '–ë—Ä–æ–Ω–∑–∞' : '–°–µ—Ä–µ–±—Ä–æ',
                win: win,
                profit: profit,
                isWin: profit > 0,
                bear: gotBear
            });

            updateUI();
        }

        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('filter-active'));
            document.getElementById('f-' + f).classList.add('filter-active');
            renderHistory();
        }

        function renderHistory() {
            const container = document.getElementById('hist-content');
            let filtered = history;
            if (currentFilter === 'win') filtered = history.filter(h => h.isWin);
            if (currentFilter === 'loss') filtered = history.filter(h => !h.isWin);

            container.innerHTML = filtered.map(
h => `
                <div class="history-item">
                    <span>${h.type}</span>
                    <span style="color:${h.isWin ? 'green' : 'red'}">
                        ${h.bear ? 'üß∏' : h.win + ' ‚úàÔ∏è'} (${h.profit >= 0 ? '+' : ''}${h.profit})
                    </span>
                </div>
            `).join('');
        }

        function renderInventory() {
            const container = document.getElementById('inv-grid');
            if (items.length === 0) {
                container.innerHTML = "<p>–¢—É—Ç –ø–æ–∫–∞ –ø—É—Å—Ç–æ...</p>";
                return;
            }
            container.innerHTML = items.map(i => `
                <div class="inv-item">
                    <div style="font-size:40px">${i.icon}</div>
                    <div style="font-size:12px">${i.name}</div>
                </div>
            `).join('');
        }

        function nav(id, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active-screen');
            btn.classList.add('active');
            if (id === 'scr-hist') renderHistory();
            if (id === 'scr-inv') renderInventory();
            
# --- –ò–ú–ü–û–†–¢–´ (–¥–æ–±–∞–≤—å—Ç–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º) ---
from aiogram import F, types
from aiogram.types import LabeledPrice, PreCheckoutQuery

# --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
STARS_RATE = 1000  # –û—á–∫–æ–≤ –∑–∞ 1 –∑–≤–µ–∑–¥—É
MIN_STARS_DEPOSIT = 10  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫—É–ø
UNLOCK_WITHDRAW_THRESHOLD = 15  # –ü–æ—Ä–æ–≥ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤—ã–≤–æ–¥–∞

# --- –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–ü–û–õ–ù–ï–ù–ò–Ø (STARS) ---

@router.callback_query(F.data == "top_up_stars")
async def send_payment_invoice(callback: types.CallbackQuery):
    # –ü—Ä–∏–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ –Ω–∞ 10 –∑–≤–µ–∑–¥
    await callback.message.answer_invoice(
        title="–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤",
        description=f"–ü–æ–∫—É–ø–∫–∞ –∏–≥—Ä–æ–≤—ã—Ö –æ—á–∫–æ–≤ (–∫—É—Ä—Å: 1 ‚≠êÔ∏è = {STARS_RATE} –æ—á–∫–æ–≤)",
        prices=[LabeledPrice(label="XTR", amount=10)],  # 10 –∑–≤–µ–∑–¥
        payload="stars_deposit_10",
        currency="XTR"
    )

@router.chat_join_request()
@router.pre_checkout_query()
async def process_pre_checkout(pre_checkout_query: PreCheckoutQuery):
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç—å –ø–ª–∞—Ç–µ–∂
    await pre_checkout_query.answer(ok=True)

@router.message(F.successful_payment)
async def on_successful_payment(message: types.Message):
    stars_amount = message.successful_payment.total_amount
    points_to_add = stars_amount * STARS_RATE
    
    # –õ–û–ì–ò–ö–ê: –û–±–Ω–æ–≤–∏—Ç–µ –≤ –ë–î –±–∞–ª–∞–Ω—Å –æ—á–∫–æ–≤ –∏ —Å—É–º–º—É –¥–æ–Ω–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # user.points += points_to_add
    # user.total_donated_stars += stars_amount
    
    await message.answer(
        f"‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n"
        f"–ó–∞—á–∏—Å–ª–µ–Ω–æ: {points_to_add} –æ—á–∫–æ–≤.\n"
        f"–í–∞—à —Å—Ç–∞—Ç—É—Å –≤—ã–≤–æ–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω."
    )

# --- –õ–û–ì–ò–ö–ê –ò–ù–í–ï–ù–¢–ê–†–Ø –ò –í–´–í–û–î–ê ---

@router.callback_query(F.data == "withdraw_request")
async def handle_withdraw(callback: types.CallbackQuery):
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –≤—ã–∑–æ–≤—ã)
    # user_donated = db.get_user_donated(callback.from_user.id)
    user_donated = 0 # –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
    
    if user_donated < UNLOCK_WITHDRAW_THRESHOLD:
        await callback.answer(
            f"üö´ –í—ã–≤–æ–¥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!\n\n"
            f"–î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–¥–æ–Ω–∞—Ç–∏—Ç—å –º–∏–Ω–∏–º—É–º {UNLOCK_WITHDRAW_THRESHOLD} –∑–≤–µ–∑–¥.\n"
            f"–í–∞–º –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ–Ω–∞—Ç–∏—Ç—å: {UNLOCK_WITHDRAW_THRESHOLD - user_donated} ‚≠êÔ∏è",
            show_alert=True
        )
    else:
        # –õ–æ–≥–∏–∫–∞ —Å–∞–º–æ–≥–æ –≤—ã–≤–æ–¥–∞
        await callback.message.edit_text(
            "üí∞ –ú–µ–Ω—é –≤—ã–≤–æ–¥–∞\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ—á–∫–æ–≤, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏:"
        )

        }

        updateUI();
    </script>
</body>
</html>
