
import asyncio
from aiogram import Bot, Dispatcher, F, types
from aiogram.filters import Command
from aiogram.types import LabeledPrice, PreCheckoutQuery, InlineKeyboardButton, InlineKeyboardMarkup

# –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω
API_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê"

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# --- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ ---
def get_main_menu():
    buttons = [
        [InlineKeyboardButton(text="–ù–∞—á–∞—Ç—å –∏–≥—Ä—É üéÆ", callback_data="start_game")],
        [InlineKeyboardButton(text="–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç (10 ‚≠êÔ∏è)", callback_data="buy_stars")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)

# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start ---
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    await message.answer(
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É! –ù–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –∏–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.",
        reply_markup=get_main_menu()
    )

# --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—á–µ—Ç–∞ (Invoice) –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É ---
@dp.callback_query(F.data == "buy_stars")
async def send_invoice(callback: types.CallbackQuery):
    await callback.message.answer_invoice(
        title="–î–æ–Ω–∞—Ç –∑–≤–µ–∑–¥",
        description="–ü–æ–∫—É–ø–∫–∞ 10 –∑–≤–µ–∑–¥ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏–≥—Ä—ã",
        payload="internal_payment_payload_10", # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä
        currency="XTR", # –í–∞–ª—é—Ç–∞ Telegram Stars
        prices=[LabeledPrice(label="XTR", amount=10)] # –ú–∏–Ω–∏–º—É–º 10 –∑–≤–µ–∑–¥
    )
    await callback.answer()

# --- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂–∞ (PreCheckoutQuery) ---
@dp.pre_checkout_query()
async def process_pre_checkout(pre_checkout_query: PreCheckoutQuery):
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞ –≤ –±–∞–∑–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    await pre_checkout_query.answer(ok=True)

# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ ---
@dp.message(F.successful_payment)
async def success_payment_handler(message: types.Message):
    payment_info = message.successful_payment
    await message.answer(
        f"–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! üéâ\n"
        f"–í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏: {payment_info.total_amount} ‚≠êÔ∏è\n"
        f"ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: {payment_info.telegram_payment_charge_id}"
    )

# --- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ---
async def main():
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É –∑–≤–µ–∑–¥...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("–ë–æ—Ç –≤—ã–∫–ª—é—á–µ–Ω")
