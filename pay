
# --- –ò–ú–ü–û–†–¢–´ (–¥–æ–±–∞–≤—å—Ç–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º) ---
from aiogram import F, types
from aiogram.types import LabeledPrice, PreCheckoutQuery

# --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
STARS_RATE = 1000  # –û—á–∫–æ–≤ –∑–∞ 1 –∑–≤–µ–∑–¥—É
MIN_STARS_DEPOSIT = 10  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫—É–ø
UNLOCK_WITHDRAW_THRESHOLD = 15  # –ü–æ—Ä–æ–≥ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤—ã–≤–æ–¥–∞

# --- –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–ü–û–õ–ù–ï–ù–ò–Ø (STARS) ---

@router.callback_query(F.data == "top_up_stars")
async def send_payment_invoice(callback: types.CallbackQuery):
    # –ü—Ä–∏–º–µ—Ä –∏–Ω–≤–æ–π—Å–∞ –Ω–∞ 10 –∑–≤–µ–∑–¥
    await callback.message.answer_invoice(
        title="–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤",
        description=f"–ü–æ–∫—É–ø–∫–∞ –∏–≥—Ä–æ–≤—ã—Ö –æ—á–∫–æ–≤ (–∫—É—Ä—Å: 1 ‚≠êÔ∏è = {STARS_RATE} –æ—á–∫–æ–≤)",
        prices=[LabeledPrice(label="XTR", amount=10)],  # 10 –∑–≤–µ–∑–¥
        payload="stars_deposit_10",
        currency="XTR"
    )

@router.chat_join_request()
@router.pre_checkout_query()
async def process_pre_checkout(pre_checkout_query: PreCheckoutQuery):
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω—è—Ç—å –ø–ª–∞—Ç–µ–∂
    await pre_checkout_query.answer(ok=True)

@router.message(F.successful_payment)
async def on_successful_payment(message: types.Message):
    stars_amount = message.successful_payment.total_amount
    points_to_add = stars_amount * STARS_RATE
    
    # –õ–û–ì–ò–ö–ê: –û–±–Ω–æ–≤–∏—Ç–µ –≤ –ë–î –±–∞–ª–∞–Ω—Å –æ—á–∫–æ–≤ –∏ —Å—É–º–º—É –¥–æ–Ω–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # user.points += points_to_add
    # user.total_donated_stars += stars_amount
    
    await message.answer(
        f"‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n"
        f"–ó–∞—á–∏—Å–ª–µ–Ω–æ: {points_to_add} –æ—á–∫–æ–≤.\n"
        f"–í–∞—à —Å—Ç–∞—Ç—É—Å –≤—ã–≤–æ–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω."
    )

# --- –õ–û–ì–ò–ö–ê –ò–ù–í–ï–ù–¢–ê–†–Ø –ò –í–´–í–û–î–ê ---

@router.callback_query(F.data == "withdraw_request")
async def handle_withdraw(callback: types.CallbackQuery):
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –≤—ã–∑–æ–≤—ã)
    # user_donated = db.get_user_donated(callback.from_user.id)
    user_donated = 0 # –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
    
    if user_donated < UNLOCK_WITHDRAW_THRESHOLD:
        await callback.answer(
            f"üö´ –í—ã–≤–æ–¥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!\n\n"
            f"–î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–¥–æ–Ω–∞—Ç–∏—Ç—å –º–∏–Ω–∏–º—É–º {UNLOCK_WITHDRAW_THRESHOLD} –∑–≤–µ–∑–¥.\n"
            f"–í–∞–º –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ–Ω–∞—Ç–∏—Ç—å: {UNLOCK_WITHDRAW_THRESHOLD - user_donated} ‚≠êÔ∏è",
            show_alert=True
        )
    else:
        # –õ–æ–≥–∏–∫–∞ —Å–∞–º–æ–≥–æ –≤—ã–≤–æ–¥–∞
        await callback.message.edit_text(
            "üí∞ –ú–µ–Ω—é –≤—ã–≤–æ–¥–∞\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ—á–∫–æ–≤, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏:"
        )
